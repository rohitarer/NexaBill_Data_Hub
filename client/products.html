<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product List</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* guarantee the modal is hidden when [hidden] is set */
    .modal-overlay[hidden]{ display:none !important; }
  </style>
</head>
<body>
  <nav>
    <div class="logo">NexaBill Data Hub</div>
    <ul>
      <li><a href="index.html">Add Product</a></li>
      <li><a href="products.html">View Products</a></li>
    </ul>
  </nav>

  <main class="product-list-container">
    <h1>All Products</h1>
    <div id="productList" class="product-list"></div>
  </main>

  <!-- Edit Modal -->
  <div id="editOverlay" class="modal-overlay" hidden>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal-header">
        <h2 id="editTitle">Edit Product</h2>
        <button id="editCloseBtn" class="modal-close" aria-label="Close">✕</button>
      </div>

      <form id="editForm" enctype="multipart/form-data">
        <div class="grid-2">
          <div class="form-group">
            <label>Product ID</label>
            <input type="text" id="editProductId" name="productId" readonly />
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="editName" name="name" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Brand</label>
            <input type="text" id="editBrand" name="brand" />
          </div>
          <div class="form-group">
            <label>MRP</label>
            <input type="number" step="0.01" id="editMrp" name="mrp" />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Weight</label>
            <input type="text" id="editWeight" name="weight" />
          </div>
          <div class="form-group">
            <label>Flavor</label>
            <input type="text" id="editFlavor" name="flavor" />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>GST (%)</label>
            <input type="number" step="1" id="editGst" name="gst" />
          </div>
          <div class="form-group">
            <label>Replace Image (optional)</label>
            <input type="file" id="editImage" name="image" accept="image/*" />
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn secondary" id="editCancel">Cancel</button>
          <button type="submit" class="btn primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:5001";
    const listEl = document.getElementById("productList");
    const known = new Map(); // productId -> { element, data }
    let firstLoadDone = false;
    let loading = false;

    // ---------- helpers ----------
    function makeProductImg(src, alt = "product image") {
      const img = document.createElement("img");
      img.className = "product-img";
      img.alt = alt;
      img.loading = "lazy";
      img.decoding = "async";
      const bust = src.includes("?") ? `&t=${Date.now()}` : `?t=${Date.now()}`;
      img.src = `${src}${bust}`;
      const markLoaded = () => img.classList.add("is-loaded");
      if (img.complete) requestAnimationFrame(markLoaded);
      else {
        img.addEventListener("load", markLoaded, { once: true });
        img.addEventListener("error", markLoaded, { once: true });
        setTimeout(markLoaded, 1500);
      }
      return img;
    }

    function skeletonCard() {
      const wrap = document.createElement("div");
      wrap.className = "product-card skeleton";
      wrap.innerHTML = `
        <div class="img"></div>
        <div class="meta">
          <div class="line w60"></div>
          <div class="line w40"></div>
          <div class="line w50"></div>
        </div>`;
      return wrap;
    }

    function actionBar(p) {
      const bar = document.createElement("div");
      bar.className = "card-actions";

      const left = document.createElement("div");
      const right = document.createElement("div");

      const badge = document.createElement("span");
      badge.className = "id-badge";
      badge.textContent = `#${p.productId}`;
      left.appendChild(badge);

      const editBtn = document.createElement("button");
      editBtn.className = "icon-btn edit";
      editBtn.title = "Edit";
      editBtn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M3 17.25V21h3.75l11-11.03l-3.75-3.75L3 17.25zM21.71 6.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83l3.75 3.75l1.84-1.82z"/>
        </svg>`;
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openEditModal(p);
      });

      const delBtn = document.createElement("button");
      delBtn.className = "icon-btn delete";
      delBtn.title = "Delete";
      delBtn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6zm3-10h2v9H9zm4 0h2v9h-2zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>`;
      delBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const ok = confirm(`Delete product #${p.productId} (${p.name})?`);
        if (!ok) return;
        try {
          const res = await fetch(`${API_BASE}/api/products/${p.productId}`, { method: "DELETE" });
          if (!res.ok) throw new Error(await res.text());
          const item = known.get(p.productId);
          if (item) {
            item.element.remove();
            known.delete(p.productId);
          }
        } catch (err) {
          alert("Failed to delete: " + err.message);
        }
      });

      right.appendChild(editBtn);
      right.appendChild(delBtn);
      bar.appendChild(left);
      bar.appendChild(right);
      return bar;
    }

    function productCard(p) {
      const card = document.createElement("div");
      card.className = "product-card";

      const actions = actionBar(p);
      const img = makeProductImg(`${API_BASE}/${p.image_path}`, p.name || "product image");

      const info = document.createElement("div");
      info.className = "product-info";
      const price = Number(p.mrp || 0).toFixed(2);
      info.innerHTML = `
        <h3>${p.name} <span class="id-inline">#${p.productId}</span></h3>
        <p><strong>Brand:</strong> ${p.brand ?? "-"}</p>
        <p><strong>MRP:</strong> ₹${price}</p>
        <p><strong>Weight:</strong> ${p.weight ?? "-"}</p>
        ${p.flavor ? `<p><strong>Flavor:</strong> ${p.flavor}</p>` : ""}
        <p><strong>GST:</strong> ${p.gst ?? 0}%</p>
      `;

      card.appendChild(actions);
      card.appendChild(img);
      card.appendChild(info);
      return card;
    }

    async function fetchProducts() {
      const res = await fetch(`${API_BASE}/api/products`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function refreshOnce() {
      if (loading) return;
      loading = true;
      try {
        if (!firstLoadDone && listEl.children.length === 0) {
          for (let i = 0; i < 3; i++) listEl.appendChild(skeletonCard());
        }
        const data = await fetchProducts();
        const frag = document.createDocumentFragment();
        for (const p of data) {
          if (known.has(p.productId)) continue;
          const card = productCard(p);
          known.set(p.productId, { element: card, data: p });
          frag.appendChild(card);
        }
        if (!firstLoadDone && known.size > 0) {
          [...listEl.querySelectorAll(".skeleton")].forEach(n => n.remove());
          firstLoadDone = true;
        }
        if (frag.childNodes.length) listEl.appendChild(frag);
      } catch (err) {
        console.error("Failed to load products:", err);
        if (!firstLoadDone) {
          [...listEl.querySelectorAll(".skeleton")].forEach(n => n.remove());
          const msg = document.createElement("div");
          msg.style.padding = "12px";
          msg.style.color = "#b91c1c";
          msg.textContent = "Could not load products.";
          listEl.appendChild(msg);
        }
      } finally {
        loading = false;
      }
    }

    // ---------- EDIT MODAL ----------
    const overlay = document.getElementById("editOverlay");
    const form    = document.getElementById("editForm");
    const closeBtn= document.getElementById("editCloseBtn");
    const cancelBt= document.getElementById("editCancel");

    function openEditModal(p) {
      // fill fields
      document.getElementById("editProductId").value = p.productId;
      document.getElementById("editName").value      = p.name || "";
      document.getElementById("editBrand").value     = p.brand || "";
      document.getElementById("editMrp").value       = p.mrp ?? "";
      document.getElementById("editWeight").value    = p.weight || "";
      document.getElementById("editFlavor").value    = p.flavor || "";
      document.getElementById("editGst").value       = p.gst ?? "";

      // clear file input
      document.getElementById("editImage").value = "";

      overlay.hidden = false;
      // little focus trap start
      setTimeout(() => document.getElementById("editName").focus(), 0);
    }

    function closeEditModal() { overlay.hidden = true; }

    // click X or Cancel
    closeBtn.addEventListener("click", closeEditModal);
    cancelBt.addEventListener("click", closeEditModal);
    // click on backdrop
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeEditModal();
    });
    // esc to close
    document.addEventListener("keydown", (e) => {
      if (!overlay.hidden && e.key === "Escape") closeEditModal();
    });

    // submit changes
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editProductId").value;
      const fd = new FormData(form); // includes optional image
      // remove productId from body—server gets it from URL
      fd.delete("productId");

      try {
        const res = await fetch(`${API_BASE}/api/products/${id}`, {
          method: "PUT",
          body: fd
        });
        if (!res.ok) throw new Error(await res.text());
        const { product } = await res.json();

        // Update UI
        const item = known.get(Number(id));
        if (item) {
          item.data = product;

          // Replace card content
          const newCard = productCard(product);
          item.element.replaceWith(newCard);
          item.element = newCard;
        }
        closeEditModal();
      } catch (err) {
        alert("Update failed: " + err.message);
      }
    });

    // ---------- init ----------
    refreshOnce();
    setInterval(refreshOnce, 5000);
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) refreshOnce();
    });
  </script>
</body>
</html>


<!-- <!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Product List</title>
		<link rel="stylesheet" href="css/styles.css" />
	</head>
	<body>
		<nav>
			<div class="logo">NexaBill Data Hub</div>
			<ul>
				<li><a href="index.html">Add Product</a></li>
				<li><a href="products.html">View Products</a></li>
			</ul>
		</nav>

		<main class="product-list-container">
			<h1>All Products</h1>
			<div id="productList" class="product-list"></div>
		</main>

		<script>
			const API_BASE = "http://localhost:5001";
			const listEl = document.getElementById("productList");
			const known = new Map(); // key -> card element
			let firstLoadDone = false;
			let loading = false;

			function skeletonCard() {
				const wrap = document.createElement("div");
				wrap.className = "product-card skeleton";
				wrap.innerHTML = `
        <div class="img"></div>
        <div class="meta">
          <div class="line w60"></div>
          <div class="line w40"></div>
          <div class="line w50"></div>
        </div>
      `;
				return wrap;
			}

			function productCard(p) {
				const card = document.createElement("div");
				card.className = "product-card";

				const img = document.createElement("img");
				img.className = "product-img";
				img.alt = p.name || "product image";
				img.loading = "lazy";
				img.decoding = "async";
				img.src = `${API_BASE}/${p.image_path}`;

				// Fade in only when loaded (prevents blink)
				if (img.complete) {
					// cached images load instantly
					img.classList.add("is-loaded");
				} else {
					img.addEventListener("load", () => img.classList.add("is-loaded"), {
						once: true,
					});
					img.addEventListener("error", () => img.classList.add("is-loaded"), {
						once: true,
					});
				}

				const info = document.createElement("div");
				info.className = "product-info";
				const price = Number(p.mrp || 0).toFixed(2);
				info.innerHTML = `
        <h3>${p.name}</h3>
        <p><strong>Brand:</strong> ${p.brand ?? "-"}</p>
        <p><strong>MRP:</strong> ₹${price}</p>
        <p><strong>Weight:</strong> ${p.weight ?? "-"}</p>
        ${p.flavor ? `<p><strong>Flavor:</strong> ${p.flavor}</p>` : ""}
        <p><strong>GST:</strong> ${p.gst ?? 0}%</p>
      `;

				card.appendChild(img);
				card.appendChild(info);
				return card;
			}

			async function fetchProducts() {
				const res = await fetch(`${API_BASE}/api/products`, {
					cache: "no-store",
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				return res.json();
			}

			async function refreshOnce() {
				if (loading) return;
				loading = true;

				try {
					// Show skeletons only on very first load
					if (!firstLoadDone && listEl.children.length === 0) {
						for (let i = 0; i < 3; i++) listEl.appendChild(skeletonCard());
					}

					const data = await fetchProducts();

					// Append only new items (no clearing → no flicker)
					const frag = document.createDocumentFragment();
					for (const p of data) {
						const key = p._id || `${p.name}-${p.image_path}`;
						if (known.has(key)) continue;
						const card = productCard(p);
						known.set(key, card);
						frag.appendChild(card);
					}

					// Remove skeletons once we have any content
					if (!firstLoadDone && known.size > 0) {
						[...listEl.querySelectorAll(".skeleton")].forEach((n) =>
							n.remove()
						);
						firstLoadDone = true;
					}

					if (frag.childNodes.length) {
						listEl.appendChild(frag); // use prepend(frag) to show newest on top
					}
				} catch (err) {
					console.error("Failed to load products:", err);
					// Optional inline non-blocking message:
					if (!firstLoadDone) {
						[...listEl.querySelectorAll(".skeleton")].forEach((n) =>
							n.remove()
						);
						const msg = document.createElement("div");
						msg.style.padding = "12px";
						msg.style.color = "#b91c1c";
						msg.textContent = "Could not load products.";
						listEl.appendChild(msg);
					}
				} finally {
					loading = false;
				}
			}

			// Initial load + gentle background refresh
			refreshOnce();
			setInterval(refreshOnce, 5000);

			// Refresh once when user returns to the tab
			document.addEventListener("visibilitychange", () => {
				if (!document.hidden) refreshOnce();
			});
		</script>
	</body>
</html>
> -->
